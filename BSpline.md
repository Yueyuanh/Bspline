
# BSpline 三次B样条曲线

*By Yueyuanhaoo*


**样条曲线（spline curve）** 是定义非常广泛，也是最常用的曲线类型。事实上，只要是使用分段多项式表达的曲线，并且在连接处满足一定的连续性，我们就可以称这条曲线为样条曲线。样条的名称来源于早期的船舶和飞机制造工业中的一种技术：通过将细木条 (称为“样条”) 穿过布置在大型设计阁楼地板上的点来构建飞机模板，如[图所示。如果我们使用分段的多项式近似整个细木条，得到的曲线就称为样条插值曲线。后来样条曲线被赋予了更广泛的定义，不需要经过这些控制点也可以被称为样条曲线。

<img src="DOC/spline.png" style="zoom:50%;" />

## B样条

B样条（Basis Splines）是一类基于**基函数**的样条，具有局部支持性和良好的数值稳定性。B样条通过线性组合一组称为B基函数（B-spline basis functions）的基函数来表示整个样条函数。它们的主要特点包括：

- **局部控制性**：每个B基函数仅在有限的节点范围内非零，修改一个基函数不会影响远处的样条形状。
- **数值稳定性**：基于递归的定义方法，B样条具有良好的数值性质，适合大规模数据处理。
- **灵活性高**：可以通过调整节点数量、基函数阶数等参数，实现对样条形状的精细控制。

$$
P(u)=\sum_{i=0}^n P_i B_{i,k}(u) \quad u\in[u_{k-1},u_{n+1}]
$$

在机器人路径规划中使用归一化路径s和确定的基函数，不再使用Cox-de Boor公式递推：


$$
P(s)=f_1(s)C_1+f_2(s)C_2+f_3(s)C_3+f_4(s)C_4
$$
<img src="DOC/3BS.png" style="zoom:50%;" />

### 和三次多项式的区别

三次多项式插值方法（Cubic Spline）是一种常用的插值方法，所形成的曲线会**精确地穿过4个点**，其位置和速度曲线是连续的，加速度是可变的，但加速度不一定连续。
$$
q(t)=a_0+a_1(t-t_0)+a_2(t-t_0)^2+a_3(t-t_0)^3 ,  \quad t_0\leq t \leq t_1
$$
给定每一个点的位置和速度信息，考察给定两个数据点进行插值的情况，如果给定了初始时刻$t_0$和最终时刻$t_1$处的位置与速度信息（$q_0,q_1,v_0,v_1$）,设$h=q_1-q_0,T=t_1-t_0$，则这些参数可以使用以下公式计算：
$$
\begin{align}
a_0 &=q_0 \\
a_1 &=v_0 \\
a_2 &=\frac{3h-(2v_0+v_1)T}{T^2} \\
a_3 &=\frac{-2h+(v_0+v_1)T}{T^3}
\end{align}
$$
对于给定个一系列数据点进行插值的情况，只需要对所有相邻的两个数据点使用上述公式即可依次计算得到整条插值曲线。

<img src="DOC/3degree.png" style="zoom:30%;" />

三次多项式插值能够保证位置曲线和速度曲线是连续的，但加**速度曲线不一定连续**。虽然已经可以满足许多应用上对于“平滑”的要求了，但是在高速控制领域，一般要求加速度也要是连续的。因此，我们需要引入更高阶次的多项式插值方法。从图中可以看到，位置曲线是“平滑”的，速度曲线是连续的，加速度曲线是可变的，但是不连续。这样，对于高速控制的场合来说，控制器的输入仍然会存在阶跃，导致不连续的情况。

增加多项式阶数，五次多项式插值...

但是试图用一个高阶的多项式去插值大量的数据点是，曲线就会在端点附近出现及其剧烈的震荡，虽然数据本身是平滑的，但实际是不可用的，这就是**龙格现象**

<img src="DOC/runge.png" style="zoom:50%;" />

而对于三阶B样条来说，其本质上是多个三阶曲线的组合，数值比较稳定，不会出现龙格现象



| 三次多项式插值                       | 三阶B样条曲线                                      |
| ------------------------------------ | -------------------------------------------------- |
| 精确插值                             | 光滑逼近                                           |
| 过初始点、终点                       | 不过初始点、终点                                   |
| 位置、速度连续，加速度不一定连续     | 位置、速度、加速度连续（基函数保证）$C^2$连续      |
| 可以显式地，独立的设置每个点的导数值 | 无法直接设置某个点的导数值，但可通过增加控制点设置 |



### 四个样条函数（基函数）




$$
\begin{align}
f_1(s)&=\frac{1}{6}(-s^3+3s^2-3s+1)  \\
f_2(s)&=\frac{1}{6}(3s^3-6s^2+4) \\
f_3(s)&=\frac{1}{6}(-3s^3+3s^2+3s+1) \\
f_4(s)&=\frac{1}{6}s^3
\end{align}
$$

其中：

$s$为归一化路径：$0\leq s\leq 1$

<img src="DOC/3B.png" style="zoom: 50%;" />

基函数具有$C^2$连续性，一阶可导，二阶可导，因此其速度，加速度是连续的，有利于机器人控制。

四点B样条曲线：

<img src="DOC/4Knot.png" alt="4Knot" style="zoom:50%;" />

#### N个控制点的B样条曲线

如果超过了四个点，我们是否要用更高次幂的函数来拟合？

如果有K个点，就要用K-1次函数去拟合

这样会需要**更复杂的运算**，并且会导致牵一发而动全身的缺点，**无法进行局部调整**

当然，这就是B样条的前身：贝塞尔曲线（Bézier Curves）

##### 贝塞尔曲线

<img src="DOC/12345.gif" style="zoom: 20%;" />

Photoshop中三阶贝塞尔曲线

<img src="DOC/ps.gif" style="zoom:25%;" />



##### N个控制点的三阶B样条

<img src="DOC/4NKnot.png" style="zoom: 20%;" />

也就是：

<img src="DOC/Cn.png" style="zoom:50%;" />



### 过起始点的B样条曲线

上述样条曲线在四点中间，并不过起始点，无法达到我们的拟合或者路径规划的任务

为了能够过起始点，我们采用在起始点添加对称的**增广点**：

<img src="DOC/C1.png" style="zoom: 50%;" />

但是采用这种增广模式，如何保证如何保证$P(S)$过起点$C_1$？

<img src="DOC/4Knot1234.png" alt="4Knot1234" style="zoom: 25%;" />

#### 让我们算一算

$$
P(s)=f_1(s)C_1+f_2(s)C_2+f_3(s)C_3+f_4(s)C_4
$$

上式也可以写成矩阵形式：
$$
P(s)=\frac{1}{6} 
\begin{bmatrix}
1  &  s  & s^2 & s^3 \\
\end{bmatrix}

\begin{bmatrix}
 1  &  4  &  1  & 0 \\
 -3  &  0  &  3  & 0 \\
  3  & -6  &  3  & 0 \\
-1  &  3  & -3  & 1 
\end{bmatrix}

\begin{bmatrix}
C_1 \\
C_2 \\
C_3 \\
C_4 \\
\end{bmatrix}
$$
根据矩阵乘法结合率可知：(AB)C=A(BC)
$$
P(s)=\frac{1}{6} 
\begin{bmatrix}
1  &  s  & s^2 & s^3 \\
\end{bmatrix}

\begin{bmatrix}
 C_1+4C_2+C_3 \\
 -3C_1+3C_3   \\
 3C_1-6C_2+3C_3  \\
-C_1+3C_2-3C_3+C_4
\end{bmatrix}
$$


根据起始点增广的形式我们可以得出：
$$
\begin{align}
C_{1}&=C_{O1}-V_1L \\
C_{2}&=C_{O1} \\
C_{3}&=C_{O1}+V_1L
\end{align}
$$
可以看出，这种定义使得原本的$C_1$（或$C_n$）在增广后的**三点连线的中点**，如下图所示

<img src="DOC/4SE2.png" alt="4SE" style="zoom: 33%;" />

所以为了回答**”给定控制点[$C_1 \ C_2 \ ... \ C_N$]，如何保证$P(S)$过起点$C_1$？”**

我们可以将增广点代入上式，可得：
$$
\begin{align}
P(s)&=\frac{1}{6} 
\begin{bmatrix}
1  &  s  & s^2 & s^3 \\
\end{bmatrix}

\begin{bmatrix}
 C_2+V_1L+4C_2+C_2-V_1L \\
 -3C_2-3V_1L+3C_2-3V_1L   \\
 3C_2+3V_1L-6C_2+3C_2-3V_1L  \\
-C_2-V_1L+3C_2-3C_2+3V_1L+C_4
\end{bmatrix}
\\ 
\\
&=\frac{1}{6} 
\begin{bmatrix}
1  &  s  & s^2 & s^3 \\
\end{bmatrix}

\begin{bmatrix}
 6C_2 \\
 -6V_1L   \\
0  \\
-C_2+C_4+2V_1L
\end{bmatrix}

\\ 
\\
&=
\begin{bmatrix}
1  &  s  & s^2 & s^3 \\
\end{bmatrix}

\begin{bmatrix}
C_2 \\
-V_1L   \\
0  \\
\frac{1}{6}(-C_2+C_4+2V_1L)
\end{bmatrix}

\end{align}
$$
当$s=0$时，即在样条曲线起点：
$$
P(0)=C_2
$$
当我们重新在看这张图片时，就会恍然大悟了<img src="DOC/4SE2.png" alt="4SE" style="zoom: 33%;" />

![](DOC/B.png)

当然，对于终点$C_N$,同理：
$$
\begin{align}
C_{N-2}&=C_{ON}-V_NL \\
C_{N-1}&=C_{ON} \\
C_{N}  &=C_{ON}+V_NL
\end{align}
$$
代入增广矩阵方程：
$$
P(s)=\frac{1}{6} 
\begin{bmatrix}
1  &  s  & s^2 & s^3 \\
\end{bmatrix}

\begin{bmatrix}
 1  &  4  &  1  & 0 \\
 -3  &  0  &  3  & 0 \\
  3  & -6  &  3  & 0 \\
-1  &  3  & -3  & 1 
\end{bmatrix}

\begin{bmatrix}
C_{N-3} \\
C_{N-2} \\
C_{N-1} \\
C_{N} \\
\end{bmatrix}
$$
太懒了，不想手算了 :(

<img src="DOC/matlab_Cn.png" style="zoom: 50%;" />

根据MATLAB符号运算工具可知：
$$
P(1)=C_{N-1}
$$
即最后三点的中点，**原始控制点的终点**！

当然如果我们改变增广点的位置，使其不对称，就会出现以下情况：

<img src="DOC/SX15.png" style="zoom:50%;" />

对应图像变化：

<img src="DOC/SX15P.png" style="zoom:20%;" />

是两点中点吗？

show me your code

当然我们可以通过MATLAB符号运算工具轻松得出任意增广点位的起始点和终点情况：

<img src="DOC/matlab_C1F.png" style="zoom:50%;" />

即：
$$
P(0)=C_2-\frac{V_{11}L}{6}+\frac{V_{12}L}{6} \\
P(1)=C_{N-1}-\frac{V_{N1}L}{6}+\frac{V_{N2}L}{6} \\
$$

### 三次B样条在起始点速度对样条的影响

#### 从应用角度：

![](DOC/Carlike_Gohome.png)

针对第二个入库问题，下列哪个是最合适的解法：

![](DOC/DiffDir.png)

所以，起始点的速度$V$不同（方向和大小），最后生成的B样条也不同，最终方向取决于实际需求

<img src="DOC/Bspline_animation.gif" style="zoom:30%;" />

# Source Code

<img src="DOC/qrcode_github.com.png" style="zoom:50%;" />





